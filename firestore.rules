// Allow read of public visitor-tier articles; restrict others by role.
// Collections:
// - articles: { title, description, thumbnailUrl, linkUrl?, contentHtml?, type: 'newsletter'|'market', tier, createdAt }
// - course_enrollments
// - user_roles: doc id = user uid; { email, role }
// - settings/flash, settings/brand

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function userRole() {
      return get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.role;
    }
    function canReadArticle(articleTier) {
      return articleTier == 'visitor' ||
        (isSignedIn() && (
          (articleTier == 'free' && (userRole() == 'free' || userRole() == 'paid')) ||
          (articleTier == 'paid' && userRole() == 'paid')
        ));
    }
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.email == 'darpan.pmp@gmail.com';
    }

    match /articles/{id} {
      allow read: if canReadArticle(resource.data.tier);
      allow create, update, delete: if isAdmin();
    }

    match /course_enrollments/{id} {
      allow create: if true; // anyone can submit
      allow read, update, delete: if isAdmin();
    }

    match /user_roles/{uid} {
      allow read: if isAdmin();
      allow create, update: if isAdmin();
    }

    match /settings/{doc} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
